<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="spj.entity.BkuSpjPajakMapper">
    
    
    <insert id="insertBKU" parameterType="spp.model.BukuKasUmum"  useGeneratedKeys="true"  keyColumn="I_ID" >
        INSERT INTO TMBKUSKPDPENGELUARAN (
        I_ID, 
        C_ANGG_TAHUN,
        I_IDSKPD,
        D_POSTING,
        C_TRX,
        I_DOC_BUKTI,
        I_IDTRX,
        D_DOC_BUKTI,
        E_DOC_BUKTI,
        I_IDKEGIATAN,
        C_KEGIATAN,
        I_IDBAS,
        C_AKUN,
        V_KAS_TERIMA,
        V_KAS_KELUAR,
        C_JENIS,
        C_BEBAN,
        I_BKUNO,
        I_FILLING,
        I_PGUN_REKAM,
        D_PGUN_REKAM
        
        )VALUES(
        SEQ_TMBKUSKPDPENGELUARAN.NEXTVAL,
        #{tahun},
        #{idskpd},
        #{tglPosting},
        #{kodeTransaksi},
        #{noDok},
        #{idsp2d},
        #{tglDok},
        #{uraianBukti}, 
        #{idKegiatan},
        #{kodeKeg},
        #{idBas},
        #{kodeakun},
        #{nilaiMasuk},
        #{nilaiKeluar},
        #{jenis},
        #{beban},
        #{noBKU},
        #{inboxFile},
        #{idEntry},
        sysdate
        )
    </insert>
        
    <select id="getKegiatan" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        SELECT idKegiatan, kodeKeg, namaKeg FROM  (SELECT   ROWNUM AS rn, a.* FROM (        
        SELECT DISTINCT  tmspdrincibl.i_idkegiatan as idKegiatan,
        tmdpakegiatan.c_kegiatan as kodeKeg, tmdpakegiatan.n_kegiatan as namaKeg
        FROM tmspd, tmspdrincibl,  tmspdsah,
        tmdpakegiatan, tmspp, tmspprincibl,  tmsp2d
        WHERE tmspd.i_id = tmspdrincibl.i_idspd
        AND tmspd.i_id = tmspdsah.i_id
        AND tmdpakegiatan.i_id = tmspdrincibl.i_idkegiatan
        AND tmspd.i_idskpd = tmspp.i_idskpd
        AND tmspd.c_angg_tahun = tmspp.c_angg_tahun
        AND tmspp.i_id = tmspprincibl.i_idspp
        AND tmspd.i_id = tmspprincibl.i_idspd
        AND tmspp.i_id = tmsp2d.i_idspp
        AND tmsp2d.c_sp2d_sah = '1'
        AND tmspp.c_jenis = '3'
        AND tmspp.c_beban &lt;&gt; 'LS'
        AND tmspd.c_angg_tahun = #{tahun}                            
        AND tmspp.i_idskpd = #{idskpd}
        
        <if test="nama != null and nama != '' ">
            and upper(tmdpakegiatan.n_kegiatan) like '%'||upper(#{nama})||'%'
        </if>
        
        <if test="kode != null and kode != '' ">
            and upper(tmdpakegiatan.c_kegiatan) like '%'||upper(#{kode})||'%'
        </if>
        
        ) a) WHERE ROWNUM &lt;= #{limit} AND rn &gt; #{offset}
        
    </select>
    
    <select id="getBannyakKegiatan" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT count(*) as banyak from (
        SELECT DISTINCT  tmspdrincibl.i_idkegiatan as idKegiatan,
        tmdpakegiatan.c_kegiatan as kodeKeg, tmdpakegiatan.n_kegiatan as namaKeg
        FROM tmspd, tmspdrincibl,  tmspdsah,
        tmdpakegiatan, tmspp, tmspprincibl,  tmsp2d
        WHERE tmspd.i_id = tmspdrincibl.i_idspd
        AND tmspd.i_id = tmspdsah.i_id
        AND tmdpakegiatan.i_id = tmspdrincibl.i_idkegiatan
        AND tmspd.i_idskpd = tmspp.i_idskpd
        AND tmspd.c_angg_tahun = tmspp.c_angg_tahun
        AND tmspp.i_id = tmspprincibl.i_idspp
        AND tmspd.i_id = tmspprincibl.i_idspd
        AND tmspp.i_id = tmsp2d.i_idspp
        AND tmsp2d.c_sp2d_sah = '1'
        AND tmspp.c_jenis = '3'
        AND tmspp.c_beban &lt;&gt; 'LS'
        AND tmspd.c_angg_tahun = #{tahun}                            
        AND tmspp.i_idskpd = #{idskpd}
        )
    </select> 
    
    <insert id="insertBkuSpj" parameterType="spp.model.BukuKasUmum"  useGeneratedKeys="true"  keyColumn="I_ID" >
        INSERT INTO TMBKUSKPDPENGELUARAN (
        I_ID, 
        C_ANGG_TAHUN,
        I_IDSKPD,
        D_POSTING,
        C_TRX,
        I_DOC_BUKTI,
        D_DOC_BUKTI,
        E_DOC_BUKTI,
        I_IDKEGIATAN,
        C_KEGIATAN,
        I_IDBAS,
        C_AKUN,
        V_KAS_TERIMA,
        V_KAS_KELUAR,
        C_JENIS,
        C_BEBAN,
        I_BKUNO,
        I_FILLING,
        I_PPTK_NIP,
        N_PPTK,
        E_RMKS,
        C_CARA_BAYAR,
        C_UANGPERSEDIAAN,
        <if test="idskpd == 761 or idskpd == 1234 ">
            C_WIL_SP2DPROSES,
        </if>
        C_BKU_KOREKSI,
        <if test="idSpd != null and idSpd > 0 ">
            I_IDSPD,
        </if>
        <if test="kodeTransaksi == 'JJ' ">
            V_SPJ_PAJAK,
            V_SPJ_NETTO,
        </if>
        <if test="ketKegiatan == 'PAJAK' ">
           I_BKUNO_REF,
        </if> 
        I_PGUN_REKAM,
        D_PGUN_REKAM
        )VALUES(
        SEQ_TMBKUSKPDPENGELUARAN.NEXTVAL,
        #{tahun},
        #{idskpd},
        #{tglPosting},
        #{kodeTransaksi},
        #{noDok},
        #{tglDok},
        #{uraianBukti}, 
        #{idKegiatan},
        #{kodeKeg},
        #{idBas},
        #{kodeakun},
        #{nilaiMasuk},
        #{nilaiKeluar},
        #{jenis},
        #{beban},
        #{noBKU},
        #{inboxFile},
        #{nipPptk},
        #{namaPptk},
        #{uraian},
        #{kodePembayaran},
        #{kodeUangPersediaan},
        <if test="idskpd == 761 or idskpd == 1234">
            #{kodeWilayah},
        </if>
        #{kodeKoreksi},
        <if test="idSpd != null and idSpd > 0 ">
            #{idSpd},
        </if>
        <if test="kodeTransaksi == 'JJ' ">
            #{nilaiPajak},
            #{nilaiSpjNetto},
        </if>
        <if test="ketKegiatan == 'PAJAK' ">
           #{noBkuSpj},
        </if>
        #{idEntry},
        sysdate
        )
    </insert>   
    
    <select id="getBkuEdit" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        select distinct tmbkuskpdpengeluaran.c_angg_tahun as tahun, SUBSTR (d_posting, 7,2) ||'/'|| SUBSTR (d_posting, 5,2) ||'/'|| SUBSTR (d_posting, 1,4) as tglPosting,  
        c_trx as kodeTransaksi, SUBSTR (d_posting, 5,2) as bulan,
        i_doc_bukti as noBukti ,  d_doc_bukti as tglDok, d_posting as noJournalDok, c_beban as beban, c_jenis as jenis, 
        i_filling as inboxFile , i_pptk_nip as nipPptk, n_pptk as namaPptk , e_rmks as uraian , i_bkuno as noBKU,
        c_cara_bayar as kodePembayaran, i_idkegiatan as idKegiatan, 
        tmdpakegiatan.c_kegiatan || ' / '|| n_kegiatan as ketKegiatan, tmdpakegiatan.c_kegiatan as kodeKeg
        from tmbkuskpdpengeluaran left join tmdpakegiatan on tmbkuskpdpengeluaran.i_idkegiatan = tmdpakegiatan.i_id
        where tmbkuskpdpengeluaran.c_angg_tahun = #{tahun}
        and tmbkuskpdpengeluaran.i_idskpd = #{idskpd}
        AND I_DOC_BUKTI = #{nobukti}
        AND D_POSTING = #{tglpost}
        and c_trx = 'JJ'
       
    </select>
        
    <select id="getKegiatanBl" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        SELECT idKegiatan, kodeKeg, namaKeg FROM  (SELECT   ROWNUM AS rn, a.* FROM (        
        SELECT DISTINCT  tmspdrincibl.i_idkegiatan as idKegiatan,
        tmdpakegiatan.c_kegiatan as kodeKeg, tmdpakegiatan.n_kegiatan as namaKeg
        FROM tmspd, tmspdrincibl,  tmspdsah,
        tmdpakegiatan, tmspp, tmspprincibl,  tmsp2d
        WHERE tmspd.i_id = tmspdrincibl.i_idspd
        AND tmspd.i_id = tmspdsah.i_id
        AND tmdpakegiatan.i_id = tmspdrincibl.i_idkegiatan
        AND tmspd.i_idskpd = tmspp.i_idskpd
        AND tmspd.c_angg_tahun = tmspp.c_angg_tahun
        AND tmspp.i_id = tmspprincibl.i_idspp
        AND tmspd.i_id = tmspprincibl.i_idspd
        AND tmspp.i_id = tmsp2d.i_idspp
        AND tmsp2d.c_sp2d_sah = '1'
        AND tmspp.c_jenis = '3'
        AND tmspp.c_beban = 'LS'
        AND tmspd.c_angg_tahun = #{tahun}                      
        AND tmspp.i_idskpd = #{idskpd}

        <if test="nama != null and nama != '' ">
            and upper(tmdpakegiatan.n_kegiatan) like '%'||upper(#{nama})||'%'
        </if>
        
        <if test="kode != null and kode != '' ">
            and upper(tmdpakegiatan.c_kegiatan) like '%'||upper(#{kode})||'%'
        </if>
        
        ) a) WHERE ROWNUM &lt;= #{limit} AND rn &gt; #{offset}
        
    </select>
    
    <select id="getBanyakKegiatanBl" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT count(*) as banyak from (
        SELECT DISTINCT  tmspdrincibl.i_idkegiatan as idKegiatan,
        tmdpakegiatan.c_kegiatan as kodeKeg, tmdpakegiatan.n_kegiatan as namaKeg
        FROM tmspd, tmspdrincibl,  tmspdsah,
        tmdpakegiatan, tmspp, tmspprincibl,  tmsp2d
        WHERE tmspd.i_id = tmspdrincibl.i_idspd
        AND tmspd.i_id = tmspdsah.i_id
        AND tmdpakegiatan.i_id = tmspdrincibl.i_idkegiatan
        AND tmspd.i_idskpd = tmspp.i_idskpd
        AND tmspd.c_angg_tahun = tmspp.c_angg_tahun
        AND tmspp.i_id = tmspprincibl.i_idspp
        AND tmspd.i_id = tmspprincibl.i_idspd
        AND tmspp.i_id = tmsp2d.i_idspp
        AND tmsp2d.c_sp2d_sah = '1'
        AND tmspp.c_jenis = '3'
        AND tmspp.c_beban = 'LS'
        AND tmspd.c_angg_tahun = #{tahun}                      
        AND tmspp.i_idskpd = #{idskpd}
        )
    </select> 
    
    
    <update id="updateBku" parameterType="spp.model.BukuKasUmum"   >
        UPDATE TMBKUSKPDPENGELUARAN
        SET
        D_POSTING = #{tglPosting},
        C_TRX = #{kodeTransaksi},
        I_DOC_BUKTI = #{noDok},
        D_DOC_BUKTI = #{tglDok},
        E_DOC_BUKTI = #{uraianBukti},
        I_IDKEGIATAN = #{idKegiatan},
        C_KEGIATAN = #{kodeKeg},
        I_IDBAS = #{idBas},
        C_AKUN = #{kodeakun},
        V_KAS_TERIMA = #{nilaiMasuk},
        V_KAS_KELUAR = #{nilaiKeluar},
        C_JENIS = #{jenis},
        C_BEBAN = #{beban},
        I_FILLING = #{inboxFile},
        I_PPTK_NIP = #{nipPptk},
        N_PPTK = #{namaPptk},
        E_RMKS = #{uraian},
        C_CARA_BAYAR = #{kodePembayaran},
        C_UANGPERSEDIAAN = #{kodeUangPersediaan},
        <if test="kodeTransaksi == 'JJ' ">
            V_SPJ_PAJAK = #{nilaiPajak},
            V_SPJ_NETTO = #{nilaiSpjNetto},
        </if>
        I_PGUN_UBAH = #{idEntry},
        D_PGUN_UBAH = sysdate
        WHERE
        C_ANGG_TAHUN = #{tahun}
        AND I_IDSKPD = #{idskpd}
        AND I_BKUNO = #{noBKU}
        AND C_TRX = #{kodeTransaksi}
            
    </update>
    
    <select id="getListSPJ" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        SELECT idBas, kodeakun, namaakun, nilaiAnggaran, nilaiBkuSp2d,
        nilaiBkuSebelum, nilaiSisa, nilaiBkuInput, nilaiPajak, idBku
        FROM  (SELECT   ROWNUM AS rn, a.* FROM (        
        
        SELECT  i_idBas as idBas, kodeakun, namaakun, SUM(V_ANGG_tapd) as nilaiAnggaran,
        SUM(BKU_SP2D_LS) as nilaiBkuSp2d, sum(V_BKU_SPJ) as nilaiBkuSebelum, 
        sum(V_ANGG_tapd - BKU_SP2D_LS - V_BKU_SPJ) as nilaiSisa,
        SUM(V_BKU_ENTRY) AS nilaiBkuInput, SUM(nilaiPajak) as nilaiPajak, nvl(sum(idBku),0) as idBku
        from (
        <!-- NILAI SPD-->
        SELECT tmspd.i_idskpd i_idskpd,tmspdrincibl.i_idkegiatan i_idkegiatan,tmspdrincibl.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , tmspdrincibl.v_spd as V_ANGG_TAPD, 0 AS BKU_SP2D_LS ,
        0 AS V_BKU_SPJ ,0 AS V_BKU_ENTRY , tmspd.i_spdno as nospd, 0 as nilaiPajak, 0 as idBku
        FROM tmspd, tmspdrincibl, tmspdsah, trbas
        WHERE tmspd.i_id = tmspdrincibl.i_idspd
        AND tmspd.i_id = tmspdsah.i_id
        AND tmspdrincibl.c_spd_status &lt;&gt; 'P'
        AND tmspdrincibl.i_idbas = trbas.i_id
        AND i_idskpd = #{idskpd}   
        AND c_angg_tahun = #{tahun}
        AND i_idkegiatan = #{idkegiatan}
       
        <!--   //NILAI KONTRAK RINCI -->
        union all
        SELECT   tmkontrakrinci.i_idskpd as i_idskpd, tmkontrakrinci.i_idkegiatan as i_idkegiatan, tmkontrakrinci.i_idbas as i_idBas, 
        TRBAS.C_AKUN as kodeakun, TRBAS.N_AKUN as namaakun , 0 AS V_ANGG_TAPD, tmkontrakrinci.v_kontrak AS BKU_SP2D_LS,
        0  as V_BKU_SPJ ,0 AS V_BKU_ENTRY, 0 as nospd, 0 as nilaiPajak, 0 as idBku
        FROM   tmkontrakrinci , TRBAS
        WHERE  (TRBAS.I_ID = tmkontrakrinci.i_idbas)
        AND tmkontrakrinci.c_angg_tahun = #{tahun}
        AND tmkontrakrinci.i_idskpd = #{idskpd}
        AND tmkontrakrinci.i_idkegiatan = #{idkegiatan} 
        
        union all <!-- NILAI SEBELUM -->
        SELECT a.i_idskpd i_idskpd,a.i_idkegiatan i_idkegiatan,a.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , 0 AS V_ANGG_TAPD ,0 AS BKU_SP2D_LS,  
        (A.V_KAS_KELUAR - A.V_KAS_TERIMA) as V_BKU_SPJ , 0 AS V_BKU_ENTRY , 0 as nospd, 0 as nilaiPajak, 0 as idBku
        FROM  TMBKUSKPDPENGELUARAN a, trbas
        WHERE  a.i_idbas = trbas.i_id
        AND a.c_angg_tahun = #{tahun}
        AND a.C_TRX='JJ'
        AND a.i_idskpd = #{idskpd}                            
        and a.i_idkegiatan = #{idkegiatan}
        AND a.i_bkuno &lt;&gt; #{nobku}
        
        union all <!-- NILAI BKU ENTRY -->
        SELECT a.i_idskpd i_idskpd,a.i_idkegiatan i_idkegiatan,a.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , 0 AS V_ANGG_TAPD ,0 AS BKU_SP2D_LS, 0  as V_BKU_SPJ , 
        (A.V_KAS_KELUAR - A.V_KAS_TERIMA) as V_BKU_ENTRY , 0 as nospd, v_spj_pajak as nilaiPajak, a.i_id as idBku
        FROM  TMBKUSKPDPENGELUARAN a, trbas
        WHERE  a.i_idbas = trbas.i_id
        AND a.c_angg_tahun = #{tahun}
        AND a.C_TRX='JJ'
        AND a.i_idskpd = #{idskpd}                            
        and a.i_idkegiatan = #{idkegiatan}
        AND a.i_bkuno = #{nobku}
        )
        group by i_idskpd , i_idkegiatan,  i_idBas, kodeakun, namaakun
        
        )a) WHERE ROWNUM &lt;= #{limit} AND rn &gt; #{offset}
        order by kodeakun
        
    </select>
    
    <select id="getListSpjTU" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        SELECT idBas, kodeakun, namaakun, nilaiAnggaran, nilaiBkuSp2d,
        nilaiBkuSebelum, nilaiSisa, nilaiBkuInput, nilaiPajak, idBku
        FROM  (SELECT   ROWNUM AS rn, a.* FROM (        
        
        SELECT  i_idBas as idBas, kodeakun, namaakun, SUM(V_ANGG_tapd) as nilaiAnggaran,
        SUM(BKU_SP2D_LS) as nilaiBkuSp2d, sum(V_BKU_SPJ) as nilaiBkuSebelum, 
        sum(BKU_SP2D_LS - V_BKU_SPJ) as nilaiSisa, nvl(sum(idBku),0) as idBku,
        SUM(V_BKU_ENTRY) AS nilaiBkuInput, SUM(nilaiPajak) as nilaiPajak
        from (
        <!-- NILAI SPD TU -->
        SELECT tmspd.i_idskpd i_idskpd,tmspdrincibl.i_idkegiatan i_idkegiatan,tmspdrincibl.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , sum(tmspdrincibl.v_spd) as V_ANGG_TAPD, 
        0 AS BKU_SP2D_LS , 0 AS V_BKU_SPJ ,0 AS V_BKU_ENTRY, 0 as nilaiPajak, 0 as idBku
        FROM   tmspd, tmspdrincibl,  tmspdsah,  tmspp,  TMSPPRINCIBL, TRBAS
        WHERE   (tmspd.i_id = tmspdsah.i_id)
        AND (tmspd.i_id = tmspdrincibl.i_idspd)
        AND (TRBAS.I_ID = tmspdrincibl.i_idbas)
        AND (tmspdrincibl.I_IDBAS = tmspprincibl.i_idbas)
        AND tmspp.i_id = tmspprincibl.i_idspp
        AND tmspd.i_id = tmspprincibl.i_idspd
        AND tmspd.c_jenis = '3' 
        AND tmspp.c_jenis = '3'
        AND tmspd.c_angg_tahun = #{tahun}
        AND tmspd.i_idskpd = #{idskpd}
        AND tmspp.C_BEBAN = 'TU'    
        AND tmspdrincibl.i_idkegiatan = #{idkegiatan}
        AND tmspprincibl.i_idkegiatan = #{idkegiatan}
        and tmspdrincibl.C_SPD_STATUS &lt;&gt; 'P'
        group by tmspd.C_ANGG_TAHUN , tmspd.i_idskpd ,  tmspdrincibl.i_idkegiatan, 
        tmspdrincibl.i_idbl, tmspdrincibl.i_idbas, TRBAS.C_AKUN, TRBAS.N_AKUN
        
        union all  <!-- NILAI LS - SPP TU -->
        SELECT tmspp.i_idskpd i_idskpd,tmspprincibl.i_idkegiatan i_idkegiatan,tmspprincibl.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , 0 as V_ANGG_TAPD, 
        tmspprincibl.v_spp AS BKU_SP2D_LS , 0 AS V_BKU_SPJ ,0 AS V_BKU_ENTRY, 0 as nilaiPajak, 0 as idBku
        FROM   tmspp,  tmspm, tmsp2d,  tmspprincibl, TRBAS
        WHERE   (tmspp.i_id = tmspm.i_idspp)
        AND (tmspm.i_id = tmsp2d.i_idspm)
        AND (tmspp.i_id = tmspprincibl.i_idspp)
        AND (TRBAS.I_ID = tmspprincibl.i_idbas)
        AND tmsp2d.c_sp2d_sah = '1'
        AND tmspp.c_beban = 'TU'
        AND tmspp.c_jenis = '3'
        AND tmspp.c_angg_tahun = #{tahun}
        AND tmspp.i_idskpd = #{idskpd}
        AND tmspprincibl.i_idkegiatan = #{idkegiatan}
        
        union all <!-- NILAI SEBELUM -->
        SELECT a.i_idskpd i_idskpd,a.i_idkegiatan i_idkegiatan,a.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , 0 AS V_ANGG_TAPD ,0 AS BKU_SP2D_LS,  
        (A.V_KAS_KELUAR - A.V_KAS_TERIMA) as V_BKU_SPJ , 0 AS V_BKU_ENTRY, 0 as nilaiPajak, 0 as idBku
        FROM  TMBKUSKPDPENGELUARAN a, trbas
        WHERE  a.i_idbas = trbas.i_id
        AND a.c_angg_tahun = #{tahun}
        AND a.C_TRX='JJ'
        AND a.i_idskpd = #{idskpd}                            
        and a.i_idkegiatan = #{idkegiatan}
        AND a.i_bkuno &lt;&gt; #{nobku}
        AND a.c_beban = 'TU'
        
        union all <!-- NILAI BKU ENTRY -->
        SELECT a.i_idskpd i_idskpd,a.i_idkegiatan i_idkegiatan,a.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , 0 AS V_ANGG_TAPD ,0 AS BKU_SP2D_LS, 0  as V_BKU_SPJ , 
        (A.V_KAS_KELUAR - A.V_KAS_TERIMA) as V_BKU_SPJ, v_spj_pajak as nilaiPajak, a.i_id as idBku
        FROM  TMBKUSKPDPENGELUARAN a, trbas
        WHERE  a.i_idbas = trbas.i_id
        AND a.c_angg_tahun = #{tahun}
        AND a.C_TRX='JJ'
        AND a.i_idskpd = #{idskpd}                            
        and a.i_idkegiatan = #{idkegiatan}
        AND a.i_bkuno = #{nobku}
        AND a.c_beban = 'TU'
        )
        group by i_idskpd , i_idkegiatan,  i_idBas, kodeakun, namaakun
        
        )a) WHERE ROWNUM &lt;= #{limit} AND rn &gt; #{offset}
        order by kodeakun
        
    </select>
    
    <select id="getBannyakListSPJ" parameterType="java.util.Map" resultType="java.lang.Integer">
        select count(*) as banyak from(
        SELECT  i_idBas as idBas, kodeakun, namaakun, SUM(V_ANGG_tapd) as nilaiAnggaran,
        SUM(BKU_SP2D_LS) as nilaiBkuSp2d, sum(V_BKU_SPJ) as nilaiBkuSebelum, 
        sum(V_ANGG_tapd - BKU_SP2D_LS - V_BKU_SPJ) as nilaiSisa,
        SUM(V_BKU_ENTRY) AS nilaiBkuInput 
        from (
        <!-- NILAI SPD-->
        SELECT tmspd.i_idskpd i_idskpd,tmspdrincibl.i_idkegiatan i_idkegiatan,tmspdrincibl.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , tmspdrincibl.v_spd as V_ANGG_TAPD, 0 AS BKU_SP2D_LS , 0 AS V_BKU_SPJ ,0 AS V_BKU_ENTRY 
        FROM tmspd, tmspdrincibl, tmspdsah, trbas
        WHERE tmspd.i_id = tmspdrincibl.i_idspd
        AND tmspd.i_id = tmspdsah.i_id
        AND tmspdrincibl.c_spd_status &lt;&gt; 'P'
        AND tmspdrincibl.i_idbas = trbas.i_id
        AND i_idskpd = #{idskpd}   
        AND c_angg_tahun = #{tahun}
        AND i_idkegiatan = #{idkegiatan}
        
        union all <!-- NILAI KONTRAK RINCI-->
        SELECT   tmkontrakrinci.i_idskpd as i_idskpd, tmkontrakrinci.i_idkegiatan as i_idkegiatan, tmkontrakrinci.i_idbas as i_idBas, 
        TRBAS.C_AKUN as kodeakun, TRBAS.N_AKUN as namaakun , 0 AS V_ANGG_TAPD, tmkontrakrinci.v_kontrak AS BKU_SP2D_LS,
        0  as V_BKU_SPJ ,0 AS V_BKU_ENTRY
        FROM   tmkontrakrinci , TRBAS
        WHERE  (TRBAS.I_ID = tmkontrakrinci.i_idbas)
        AND tmkontrakrinci.c_angg_tahun = #{tahun}
        AND tmkontrakrinci.i_idskpd = #{idskpd}
        AND tmkontrakrinci.i_idkegiatan = #{idkegiatan}
        
        union all <!-- NILAI SEBELUM -->
        SELECT a.i_idskpd i_idskpd,a.i_idkegiatan i_idkegiatan,a.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , 0 AS V_ANGG_TAPD ,0 AS BKU_SP2D_LS,  
        (A.V_KAS_KELUAR - A.V_KAS_TERIMA) as V_BKU_SPJ , 0 AS V_BKU_ENTRY 
        FROM  TMBKUSKPDPENGELUARAN a, trbas
        WHERE  a.i_idbas = trbas.i_id
        AND a.c_angg_tahun = #{tahun}
        AND a.C_TRX='JJ'
        AND a.i_idskpd = #{idskpd}                            
        and a.i_idkegiatan = #{idkegiatan}
        AND a.i_bkuno &lt;&gt; #{nobku}
        
        union all <!-- NILAI BKU ENTRY -->
        SELECT a.i_idskpd i_idskpd,a.i_idkegiatan i_idkegiatan,a.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , 0 AS V_ANGG_TAPD ,0 AS BKU_SP2D_LS, 0  as V_BKU_SPJ , 
        (A.V_KAS_KELUAR - A.V_KAS_TERIMA) as V_BKU_ENTRY 
        FROM  TMBKUSKPDPENGELUARAN a, trbas
        WHERE  a.i_idbas = trbas.i_id
        AND a.c_angg_tahun = #{tahun}
        AND a.C_TRX='JJ'
        AND a.i_idskpd = #{idskpd}                            
        and a.i_idkegiatan = #{idkegiatan}
        AND a.i_bkuno = #{nobku}
        ) group by i_idskpd , i_idkegiatan,  i_idBas, kodeakun, namaakun
        )
    </select>
    
    <select id="getBannyakListSpjTU" parameterType="java.util.Map" resultType="java.lang.Integer">
        select count(*) as banyak from(
        SELECT  i_idBas as idBas, kodeakun, namaakun, SUM(V_ANGG_tapd) as nilaiAnggaran,
        SUM(BKU_SP2D_LS) as nilaiBkuSp2d, sum(V_BKU_SPJ) as nilaiBkuSebelum, 
        sum(BKU_SP2D_LS - V_BKU_SPJ) as nilaiSisa,
        SUM(V_BKU_ENTRY) AS nilaiBkuInput 
        from (
        <!-- NILAI SPD TU -->
        SELECT tmspd.i_idskpd i_idskpd,tmspdrincibl.i_idkegiatan i_idkegiatan,tmspdrincibl.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , sum(tmspdrincibl.v_spd) as V_ANGG_TAPD, 
        0 AS BKU_SP2D_LS , 0 AS V_BKU_SPJ ,0 AS V_BKU_ENTRY 
        FROM   tmspd, tmspdrincibl,  tmspdsah,  tmspp,  TMSPPRINCIBL, TRBAS
        WHERE   (tmspd.i_id = tmspdsah.i_id)
        AND (tmspd.i_id = tmspdrincibl.i_idspd)
        AND (TRBAS.I_ID = tmspdrincibl.i_idbas)
        AND (tmspdrincibl.I_IDBAS = tmspprincibl.i_idbas)
        AND tmspp.i_id = tmspprincibl.i_idspp
        AND tmspd.i_id = tmspprincibl.i_idspd
        AND tmspd.c_jenis = '3' 
        AND tmspp.c_jenis = '3'
        AND tmspd.c_angg_tahun = #{tahun}
        AND tmspd.i_idskpd = #{idskpd}
        AND tmspp.C_BEBAN = 'TU'    
        AND tmspdrincibl.i_idkegiatan = #{idkegiatan}
        AND tmspprincibl.i_idkegiatan = #{idkegiatan}
        and tmspdrincibl.C_SPD_STATUS &lt;&gt; 'P'
        group by tmspd.C_ANGG_TAHUN , tmspd.i_idskpd ,  tmspdrincibl.i_idkegiatan, 
        tmspdrincibl.i_idbl, tmspdrincibl.i_idbas, TRBAS.C_AKUN, TRBAS.N_AKUN
        
        union all  <!-- NILAI LS - SPP TU -->
        SELECT tmspp.i_idskpd i_idskpd,tmspprincibl.i_idkegiatan i_idkegiatan,tmspprincibl.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , 0 as V_ANGG_TAPD, 
        tmspprincibl.v_spp AS BKU_SP2D_LS , 0 AS V_BKU_SPJ ,0 AS V_BKU_ENTRY 
        FROM   tmspp,  tmspm, tmsp2d,  tmspprincibl, TRBAS
        WHERE   (tmspp.i_id = tmspm.i_idspp)
        AND (tmspm.i_id = tmsp2d.i_idspm)
        AND (tmspp.i_id = tmspprincibl.i_idspp)
        AND (TRBAS.I_ID = tmspprincibl.i_idbas)
        AND tmsp2d.c_sp2d_sah = '1'
        AND tmspp.c_beban = 'TU'
        AND tmspp.c_jenis = '3'
        AND tmspp.c_angg_tahun = #{tahun}
        AND tmspp.i_idskpd = #{idskpd}
        AND tmspprincibl.i_idkegiatan = #{idkegiatan}
        
        union all <!-- NILAI SEBELUM -->
        SELECT a.i_idskpd i_idskpd,a.i_idkegiatan i_idkegiatan,a.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , 0 AS V_ANGG_TAPD ,0 AS BKU_SP2D_LS,  
        (A.V_KAS_KELUAR - A.V_KAS_TERIMA) as V_BKU_SPJ , 0 AS V_BKU_ENTRY 
        FROM  TMBKUSKPDPENGELUARAN a, trbas
        WHERE  a.i_idbas = trbas.i_id
        AND a.c_angg_tahun = #{tahun}
        AND a.C_TRX='JJ'
        AND a.i_idskpd = #{idskpd}                            
        and a.i_idkegiatan = #{idkegiatan}
        AND a.i_bkuno &lt;&gt; #{nobku}
        AND a.c_beban = 'TU'
        
        union all <!-- NILAI BKU ENTRY -->
        SELECT a.i_idskpd i_idskpd,a.i_idkegiatan i_idkegiatan,a.i_idbas as i_idBas,
        trbas.c_akun as kodeakun, trbas.n_akun as namaakun , 0 AS V_ANGG_TAPD ,0 AS BKU_SP2D_LS, 0  as V_BKU_SPJ , 
        (A.V_KAS_KELUAR - A.V_KAS_TERIMA) as V_BKU_SPJ 
        FROM  TMBKUSKPDPENGELUARAN a, trbas
        WHERE  a.i_idbas = trbas.i_id
        AND a.c_angg_tahun = #{tahun}
        AND a.C_TRX='JJ'
        AND a.i_idskpd = #{idskpd}                            
        and a.i_idkegiatan = #{idkegiatan}
        AND a.i_bkuno = #{nobku}
        AND a.c_beban = 'TU'
        ) group by i_idskpd , i_idkegiatan,  i_idBas, kodeakun, namaakun
        )
    </select>
    
    <select id="getBkuSPJEdit" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        select distinct tmbkuskpdpengeluaran.c_angg_tahun as tahun, SUBSTR (d_posting, 7,2) ||'/'|| SUBSTR (d_posting, 5,2) ||'/'|| SUBSTR (d_posting, 1,4) as tglPosting,  
        c_trx as kodeTransaksi, SUBSTR (d_posting, 5,2) as bulan, i_doc_bukti as noBukti ,  d_doc_bukti as tglDok, d_posting as noJournalDok,
        c_beban as beban, c_jenis as jenis, i_idkegiatan as idKegiatan, tmdpakegiatan.c_kegiatan || ' / '|| n_kegiatan as ketKegiatan, tmdpakegiatan.c_kegiatan as kodeKeg,
        i_filling as inboxFile, i_pptk_nip as nipPptk, n_pptk as namaPptk, i_bkuno as noBKU, e_rmks as uraian, c_cara_bayar as kodePembayaran
        from tmbkuskpdpengeluaran, tmdpakegiatan
        where tmbkuskpdpengeluaran.i_idkegiatan = tmdpakegiatan.i_id
        and tmbkuskpdpengeluaran.c_angg_tahun = #{tahun}
        and tmbkuskpdpengeluaran.i_idskpd = #{idskpd}
        and i_bkuno = #{nobku}
        <!-- and d_posting = #{tglPosting} -->
    
    </select>
    
    <delete id="deleteBkuSpj" parameterType="java.util.Map"  >
        DELETE TMBKUSKPDPENGELUARAN 
        WHERE 
        I_IDSKPD = #{idskpd}
        AND I_BKUNO = #{nobku}
        AND C_ANGG_TAHUN = #{tahun}
        
    </delete>
        
    <select id="getBkuNo" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT   NVL (MAX (i_bkuno), 0) + 1 AS nobku
        FROM   TMBKUSKPDPENGELUARAN
        WHERE   c_angg_tahun = #{tahun} AND i_idskpd = #{idskpd}
    </select>
    
    <select id="getNilaiSisaSpj" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        select nvl(sum (sp2d_upgu - nilai_spj),0) as nilaiSisa from (
        select 0 as nilai_spj , sum(v_kas_terima-v_kas_keluar) sp2d_upgu from TMBKUSKPDPENGELUARAN 
        where i_idskpd = #{idskpd}
        and c_angg_tahun = #{tahun}
        and c_trx = 'JO' 

        <if test="beban == 'UP' ">
            and c_beban in ('UP','GU')
        </if>      
        <if test="beban == 'TU' ">
            and c_beban = 'TU'
            and i_idkegiatan = #{idkegiatan}
        </if>   
        
        union all
        select  sum(v_kas_keluar - v_kas_terima)as nilai_spj , 0 AS sp2d_upgu 
        from  TMBKUSKPDPENGELUARAN 
        where  c_angg_tahun = #{tahun}
        and c_trx ='JJ'
        and i_idskpd = #{idskpd}                           
        and i_bkuno &lt;&gt; #{nobku} 
        and c_beban = #{beban}
        and c_cara_bayar = 2
        <if test="beban == 'TU' ">
            and i_idkegiatan = #{idkegiatan}
        </if>  
        )            

    </select>
    
    <select id="getNilaiValidasiSisaSpj" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        select nvl(sum(nilaiSpd),0) as nilaiSpd,  nvl(sum(nilaiKontrak),0) as nilaiKontrak, nvl(sum(nilaiTU),0) as nilaiTU, 
        nvl(sum(nilaiSetoranTU),0) as nilaiSetoranTU, nvl(sum(nilaiBku),0) as nilaiBku,
        nvl(sum (nilaiSpd - nilaiKontrak - nilaiBku - nilaiTU +nilaiSetoranTU),0) as nilaiSisa from (
        
        select tmspdrincibl.v_spd as nilaiSpd, 0 as nilaiKontrak, 0 as nilaiBku, 0 as nilaiTU, 0 as nilaiSetoranTU
        from tmspd, tmspdrincibl, tmspdsah
        where tmspd.i_id =  tmspdrincibl.i_idspd
        and tmspd.i_id = tmspdsah.i_id
        and  i_idskpd = #{idskpd}
        and c_angg_tahun =  #{tahun}
        and i_idkegiatan = #{idkegiatan}
        and tmspdrincibl.c_spd_status &lt;&gt; 'P'
       
        union all
        select 0 as nilaiSpd,  v_kontr as nilaiKontrak, 0 as nilaiBku, 0 as nilaiTU, 0 as nilaiSetoranTU
        from tmkontrak where  i_idskpd = #{idskpd}
        and c_angg_tahun =  #{tahun}
        and i_idkegiatan = #{idkegiatan}
        
        union all
        select  0 as nilaiSpd, 0 as nilaiKontrak, sum(v_kas_keluar - v_kas_terima)as nilaiBku, 0 as nilaiTU, 0 as nilaiSetoranTU
        from  TMBKUSKPDPENGELUARAN 
        where  c_angg_tahun = #{tahun}
        and c_trx ='JJ'
        and i_idskpd = #{idskpd}                           
        and i_bkuno &lt;&gt;  #{nobku}
        and c_beban = 'UP'
        and i_idkegiatan = #{idkegiatan}
        
        union all
        select  0 as nilaiSpd, 0 as nilaiKontrak, 0 as nilaiBku , v_spp as nilaiTU, 0 as nilaiSetoranTU
        from tmspp, tmspprincibl
        where  tmspp.i_id = tmspprincibl.i_idspp
        and c_beban = 'TU'
        and i_idskpd= #{idskpd}
        and c_angg_tahun = #{tahun}
        and i_idkegiatan = #{idkegiatan}
        
        union all
        select  0 as nilaiSpd, 0 as nilaiKontrak, 0 as nilaiBku , 0 as nilaiTU, v_setor as nilaiSetoranTU
        from tmsetor, tmsetorrinci
        where tmsetor.i_id = tmsetorrinci.i_idsetor
        and c_beban = 'TU'
        and i_idskpd= #{idskpd}
        and c_angg_tahun = #{tahun}
        and i_idkegiatan = #{idkegiatan}
        )   
       
    </select>
    
    <select id="getNilaiValidasiSisaSpjTU" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        select nvl(sum(nilaiSpd),0) as nilaiSpd,  nvl(sum(nilaiKontrak),0) as nilaiKontrak, nvl(sum(nilaiTU),0) as nilaiTU, 
        nvl(sum(nilaiSetoranTU),0) as nilaiSetoranTU, nvl(sum(nilaiBku),0) as nilaiBku,
        nvl(sum (nilaiSpd - nilaiKontrak - nilaiBku - nilaiTU +nilaiSetoranTU),0) as nilaiSisa from (
        
        select tmspdrincibl.v_spd as nilaiSpd, 0 as nilaiKontrak, 0 as nilaiBku, 0 as nilaiTU, 0 as nilaiSetoranTU
        from tmspd, tmspdrincibl, tmspdsah
        where tmspd.i_id =  tmspdrincibl.i_idspd
        and tmspd.i_id = tmspdsah.i_id
        and  i_idskpd = #{idskpd}
        and c_angg_tahun =  #{tahun}
        and i_idkegiatan = #{idkegiatan}
        and tmspdrincibl.c_spd_status &lt;&gt; 'P'
       
        union all
        select 0 as nilaiSpd,  v_kontr as nilaiKontrak, 0 as nilaiBku, 0 as nilaiTU, 0 as nilaiSetoranTU
        from tmkontrak where  i_idskpd = #{idskpd}
        and c_angg_tahun =  #{tahun}
        and i_idkegiatan = #{idkegiatan}
        
        union all
        select  0 as nilaiSpd, 0 as nilaiKontrak, sum(v_kas_keluar - v_kas_terima)as nilaiBku, 0 as nilaiTU, 0 as nilaiSetoranTU
        from  TMBKUSKPDPENGELUARAN 
        where  c_angg_tahun = #{tahun}
        and c_trx ='JJ'
        and i_idskpd = #{idskpd}                           
        and i_idkegiatan = #{idkegiatan}
        and c_beban = 'UP'
        
        union all
        select  0 as nilaiSpd, 0 as nilaiKontrak, 0 as nilaiBku, sum(v_kas_keluar - v_kas_terima) as nilaiTU, 0 as nilaiSetoranTU
        from  TMBKUSKPDPENGELUARAN 
        where  c_angg_tahun = #{tahun}
        and c_trx ='JJ'
        and i_idskpd = #{idskpd}                           
        and i_idkegiatan = #{idkegiatan}
        and c_beban = 'TU'
        and i_bkuno &lt;&gt;  #{nobku} 
        
        
        union all
        select  0 as nilaiSpd, 0 as nilaiKontrak, 0 as nilaiBku , 0 as nilaiTU, v_setor as nilaiSetoranTU
        from tmsetor, tmsetorrinci
        where tmsetor.i_id = tmsetorrinci.i_idsetor
        and c_beban = 'TU'
        and i_idskpd= #{idskpd}
        and c_angg_tahun = #{tahun}
        and i_idkegiatan = #{idkegiatan}
        )   
       
    </select>
    
    <select id="getBebanSpjTu" parameterType="java.util.Map" resultType="java.lang.Integer">
        select count (*) as banyak  from tmspp, tmspprincibl
        where tmspp.i_id =  tmspprincibl.i_idspp
        and c_beban = 'TU' 
        and i_idskpd = #{idskpd} 
        and c_angg_tahun = #{tahun}
        and i_idkegiatan = #{idkegiatan}
        
    </select>
    
    <select id="getKegiatanSPJ" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        SELECT   DISTINCT i_idkegiatan AS idKegiatan,
        C_ANGG_TAHUN AS tahunAnggaran,
        c_KEGIATAN AS kodeKeg,
        N_KEGIATAN AS namaKeg,
        kodeBeban AS beban
          
        FROM   (SELECT   ROWNUM AS rn, a.*
        FROM   (
        
        SELECT   DISTINCT tmspdrincibl.i_idkegiatan,
        tmspd.C_ANGG_TAHUN,
        tmspd.i_idskpd,
        tmdpakegiatan.C_KEGIATAN,
        tmdpakegiatan.N_KEGIATAN,
        'TU' as kodeBeban
        FROM   tmspd,
        tmspdrincibl,
        tmspdsah,
        tmdpakegiatan,
        tmspp,
        tmspm,
        tmsp2d
        WHERE  tmspd.i_id = tmspdrincibl.i_idspd
        and tmspd.i_id = tmspdsah.i_id
        AND tmdpakegiatan.i_id = tmspdrincibl.I_IDKEGIATAN
        AND tmspp.i_id = tmspm.i_idspp
        AND tmspm.i_id = tmsp2d.I_IDSPM
        AND tmsp2d.c_sp2d_sah = '1'
        AND tmspp.c_beban = 'TU'
        AND tmspp.c_jenis = '3'
        AND tmspp.c_angg_tahun = #{tahun}
        AND tmspp.i_idskpd = #{idskpd}
        AND  EXISTS (select 1 from tmspp , tmspprincibl
        where  tmspp.c_angg_tahun = #{tahun}  
        and tmspp.i_id =  tmspprincibl.I_idspp
        and tmspp.i_idskpd = #{idskpd}
        and tmspp.c_beban ='TU'
        and tmspprincibl.I_idkegiatan = tmdpakegiatan.I_id)
        
        union all
        SELECT   DISTINCT tmspdrincibl.i_idkegiatan, 
        tmspd.C_ANGG_TAHUN,
        tmspd.i_idskpd,
        tmdpakegiatan.C_KEGIATAN,
        tmdpakegiatan.N_KEGIATAN,
        'UP/GU' as kodeBeban
        FROM   tmspd,
        tmspdrincibl,
        tmspdsah,
        tmdpakegiatan
        WHERE  tmspd.i_id = tmspdrincibl.i_idspd
        and tmspd.i_id = tmspdsah.i_id
        AND tmdpakegiatan.i_id =   tmspdrincibl.I_IDKEGIATAN
        AND tmspd.c_jenis = '3'
        AND tmspd.c_angg_tahun = #{tahun}
        AND tmspd.i_idskpd = #{idskpd}
        
        ) a)
        WHERE ROWNUM &lt;= #{limit} AND rn &gt; #{offset} 
        <if test="nama != null and nama != '' ">
            and upper(N_KEGIATAN) like '%'||upper(#{nama})||'%'
        </if>
        
        <if test="kode != null and kode != '' ">
            and upper(C_KEGIATAN) like '%'||upper(#{kode})||'%'
        </if>
        order by c_KEGIATAN
       
    </select>   
    
    <select id="getBanyakKegiatanSPJ" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT count(*) as banyak from (
        SELECT   DISTINCT i_idkegiatan AS idKegiatan,
        C_ANGG_TAHUN AS tahunAnggaran,
        c_KEGIATAN AS kodeKeg,
        N_KEGIATAN AS namaKeg,
        kodeBeban AS beban
          
        FROM   (SELECT   ROWNUM AS rn, a.*
        FROM   (
        
        SELECT   DISTINCT tmspdrincibl.i_idkegiatan,
        tmspd.C_ANGG_TAHUN,
        tmspd.i_idskpd,
        tmdpakegiatan.C_KEGIATAN,
        tmdpakegiatan.N_KEGIATAN,
        'TU' as kodeBeban
        FROM   tmspd,tmspdsah,
        tmspdrincibl,
        tmdpakegiatan,
        tmspp,
        tmspm,
        tmsp2d
        WHERE  tmspd.i_id = tmspdrincibl.i_idspd
        and tmspd.i_id = tmspdsah.i_id
        AND tmdpakegiatan.i_id = tmspdrincibl.I_IDKEGIATAN
        AND tmspp.i_id = tmspm.i_idspp
        AND tmspm.i_id = tmsp2d.I_IDSPM
        AND tmsp2d.c_sp2d_sah = '1'
        AND tmspp.c_beban = 'TU'
        AND tmspp.c_jenis = '3'
        AND tmspp.c_angg_tahun = #{tahun}
        AND tmspp.i_idskpd = #{idskpd}
        AND  EXISTS (select 1 from tmspp , tmspprincibl
        where  tmspp.c_angg_tahun = #{tahun}  
        and tmspp.i_id =  tmspprincibl.I_idspp
        and tmspp.i_idskpd = #{idskpd}
        and tmspp.c_beban ='TU'
        and tmspprincibl.I_idkegiatan = tmdpakegiatan.I_id)
        
        union all
        SELECT   DISTINCT tmspdrincibl.i_idkegiatan, 
        tmspd.C_ANGG_TAHUN,
        tmspd.i_idskpd,
        tmdpakegiatan.C_KEGIATAN,
        tmdpakegiatan.N_KEGIATAN,
        'UP/GU' as kodeBeban
        FROM   tmspd,
        tmspdrincibl,
        tmspdsah,
        tmdpakegiatan
        WHERE  tmspd.i_id = tmspdrincibl.i_idspd
        and tmspd.i_id = tmspdsah.i_id
        AND tmdpakegiatan.i_id =   tmspdrincibl.I_IDKEGIATAN
        AND tmspd.c_jenis = '3'
        AND tmspd.c_angg_tahun = #{tahun}
        AND tmspd.i_idskpd = #{idskpd}
        ) a)
        WHERE 1=1 
        <if test="nama != null and nama != '' ">
            and upper(N_KEGIATAN) like '%'||upper(#{nama})||'%'
        </if>
        
        <if test="kode != null and kode != '' ">
            and upper(C_KEGIATAN) like '%'||upper(#{kode})||'%'
        </if>
        )
    </select> 
    
    <select id="getKodeTutup" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        select min( SUBSTR (tmbkuskpdpengeluaran.d_posting, 5, 2) ) as kodebulan , 
        bulan(min(SUBSTR (tmbkuskpdpengeluaran.d_posting, 5, 2))) as bulan , 
        c_tgl_tutup as kodeTglTutup
        from tmbkuskpdpengeluaran 
        where i_idskpd = #{idskpd} 
        and c_angg_tahun = #{tahun}
        and c_tgl_tutup is null
        group by c_tgl_tutup
    </select>
    
    <select id="getKodeTutupMax" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        select max( SUBSTR (tmbkuskpdpengeluaran.d_posting, 5, 2) ) as kodebulan , 
        bulan(max(SUBSTR (tmbkuskpdpengeluaran.d_posting, 5, 2))) as bulan , 
        c_tgl_tutup as kodeTglTutup
        from tmbkuskpdpengeluaran 
        where i_idskpd = #{idskpd} 
        and c_angg_tahun = #{tahun}
        and c_tgl_tutup is not null
        group by c_tgl_tutup
        order by c_tgl_tutup desc
    </select>
    
    <select id="getNamaNipSpjPanjar" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        select max(i_id), i_pptk_nip as nipPptk, n_pptk as namaPptk
        from tmbkuskpdpengeluaran
        where i_idskpd = #{idskpd}
        and c_angg_tahun = #{tahun}
        and c_cara_bayar = 3
        and c_trx = 'NP'
        and i_idkegiatan = #{idkegiatan}
        group by n_pptk, i_pptk_nip 
        order by max(i_id) desc
    </select>
    
    <select id="getKegiatanSpjPanjar" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        SELECT   DISTINCT i_idkegiatan AS idKegiatan,
        C_ANGG_TAHUN AS tahunAnggaran,
        c_KEGIATAN AS kodeKeg,
        N_KEGIATAN AS namaKeg,
        kodeBeban AS beban
          
        FROM   (SELECT   ROWNUM AS rn, a.*
        FROM   (
        
        SELECT   DISTINCT tmbkuskpdpengeluaran.i_idkegiatan,
        tmbkuskpdpengeluaran.C_ANGG_TAHUN,
        tmbkuskpdpengeluaran.i_idskpd,
        tmdpakegiatan.C_KEGIATAN,
        tmdpakegiatan.N_KEGIATAN,
        tmbkuskpdpengeluaran.c_beban as kodeBeban
        FROM   tmbkuskpdpengeluaran,
        tmdpakegiatan
        WHERE  tmbkuskpdpengeluaran.I_IDKEGIATAN = tmdpakegiatan.i_id
        and tmbkuskpdpengeluaran.c_angg_tahun = tmdpakegiatan.c_angg_tahun
        AND tmbkuskpdpengeluaran.i_idskpd = tmdpakegiatan. i_idskpd
        AND tmbkuskpdpengeluaran.c_trx= 'NP'
        AND tmbkuskpdpengeluaran.c_angg_tahun = #{tahun}
        AND tmbkuskpdpengeluaran.i_idskpd = #{idskpd}
        ) a)
        WHERE ROWNUM &lt;= #{limit} AND rn &gt; #{offset} 
        <if test="nama != null and nama != '' ">
            and upper(N_KEGIATAN) like '%'||upper(#{nama})||'%'
        </if>
        
        <if test="kode != null and kode != '' ">
            and upper(C_KEGIATAN) like '%'||upper(#{kode})||'%'
        </if>
        order by c_KEGIATAN
        
    </select>   
    
    <select id="getBanyakKegiatanSpjPanjar" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT count(*) as banyak from (
        SELECT   DISTINCT i_idkegiatan AS idKegiatan,
        C_ANGG_TAHUN AS tahunAnggaran,
        c_KEGIATAN AS kodeKeg,
        N_KEGIATAN AS namaKeg,
        kodeBeban AS beban
          
        FROM   (SELECT   ROWNUM AS rn, a.*
        FROM   (
        
        SELECT   DISTINCT tmbkuskpdpengeluaran.i_idkegiatan,
        tmbkuskpdpengeluaran.C_ANGG_TAHUN,
        tmbkuskpdpengeluaran.i_idskpd,
        tmdpakegiatan.C_KEGIATAN,
        tmdpakegiatan.N_KEGIATAN,
        tmbkuskpdpengeluaran.c_beban as kodeBeban
        FROM   tmbkuskpdpengeluaran,
        tmdpakegiatan
        WHERE  tmbkuskpdpengeluaran.I_IDKEGIATAN = tmdpakegiatan.i_id
        and tmbkuskpdpengeluaran.c_angg_tahun = tmdpakegiatan.c_angg_tahun
        AND tmbkuskpdpengeluaran.i_idskpd = tmdpakegiatan. i_idskpd
        AND tmbkuskpdpengeluaran.c_trx= 'NP'
        AND tmbkuskpdpengeluaran.c_angg_tahun = #{tahun}
        AND tmbkuskpdpengeluaran.i_idskpd = #{idskpd}
        ) a)
        WHERE rn &gt; #{offset} 
        <if test="nama != null and nama != '' ">
            and upper(N_KEGIATAN) like '%'||upper(#{nama})||'%'
        </if>
        
        <if test="kode != null and kode != '' ">
            and upper(C_KEGIATAN) like '%'||upper(#{kode})||'%'
        </if>
        )
    </select> 
    
    <select id="getKegiatanByBeban" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        SELECT idKegiatan, kodeKeg, namaKeg FROM  (SELECT   ROWNUM AS rn, a.* FROM (        
        SELECT DISTINCT  A.i_idkegiatan as idKegiatan,
        B.c_kegiatan as kodeKeg, B.n_kegiatan as namaKeg
        FROM tmbkuskpdpengeluaran A,  tmdpakegiatan B
        WHERE  A.i_idkegiatan = B.i_id
        AND A.i_idskpd = B.i_idskpd
        AND A.c_angg_tahun = B.c_angg_tahun
        AND A.c_beban = #{beban}
        AND A.c_angg_tahun = #{tahun}               
        AND A.i_idskpd = #{idskpd}
        
        <if test="nama != null and nama != '' ">
            and upper(B.n_kegiatan) like '%'||upper(#{nama})||'%'
        </if>
        
        <if test="kode != null and kode != '' ">
            and upper(B.c_kegiatan) like '%'||upper(#{kode})||'%'
        </if>
        
        ) a) WHERE ROWNUM &lt;= #{limit} AND rn &gt; #{offset}
        
    </select>
    
    <select id="getBanyakKegiatanByBeban" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT count(*) as banyak from (
        SELECT DISTINCT  A.i_idkegiatan as idKegiatan,
        B.c_kegiatan as kodeKeg, B.n_kegiatan as namaKeg
        FROM tmbkuskpdpengeluaran A,  tmdpakegiatan B
        WHERE  A.i_idkegiatan = B.i_id
        AND A.i_idskpd = B.i_idskpd
        AND A.c_angg_tahun = B.c_angg_tahun
        AND A.c_beban = #{beban}
        AND A.c_angg_tahun = #{tahun}               
        AND A.i_idskpd = #{idskpd}
        
        <if test="nama != null and nama != '' ">
            and upper(B.n_kegiatan) like '%'||upper(#{nama})||'%'
        </if>
        
        <if test="kode != null and kode != '' ">
            and upper(B.c_kegiatan) like '%'||upper(#{kode})||'%'
        </if>
        )
    </select> 
    
    <select id="getBulanByRekap" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        select trim(to_char(nvl(max(c_bln_tutup),0)+1 ,'00')) as kodebulan, 
        bulan(trim(to_char(nvl(max(c_bln_tutup),0)+1 ,'00')) ) as bulan
        from  tmskpdbkurekap where i_idskpd = #{idskpd} 
        and c_angg_tahun = #{tahun} 
        and d_bku_proses is not null
        
    </select>
    
    <select id="getListPajak" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        SELECT idBas, kodeakun, namaakun, jenis, nilai as nilaiPajak
        FROM  (SELECT   ROWNUM AS rn, a.* FROM (        
        select i_id as idBas, c_akun as kodeakun, n_akun as namaakun, 'P1' as jenis ,  
        (select nvl(sum(v_kas_terima),0) as nilai from tmbkuskpdpengeluaran 
        where c_trx = 'P1' and c_angg_tahun = #{tahun} and i_idskpd = #{idskpd}  and i_idbas =  #{idbas} and i_bkuno_ref = #{nobkuref}) as nilai
        from trbas where (i_id = 11554 or i_id = 3904)
        union all
        select i_id as idBas, c_akun as kodeakun, n_akun as namaakun, 'P2' as jenis,
        (select nvl(sum(v_kas_terima),0) as nilai from tmbkuskpdpengeluaran 
        where c_trx = 'P2' and c_angg_tahun = #{tahun} and i_idskpd = #{idskpd}  and i_idbas =  #{idbas} and i_bkuno_ref = #{nobkuref}) as nilai
        from trbas where (i_id = 11555 or i_id = 3905)
        union all
        select i_id as idBas, c_akun as kodeakun, n_akun as namaakun, 'P3' as jenis,
        (select nvl(sum(v_kas_terima),0) as nilai from tmbkuskpdpengeluaran 
        where c_trx = 'P3' and c_angg_tahun = #{tahun} and i_idskpd = #{idskpd}  and i_idbas =  #{idbas} and i_bkuno_ref = #{nobkuref}) as nilai
        from trbas where (i_id = 11556 or i_id = 3906)
        union all
        select i_id as idBas, c_akun as kodeakun, n_akun as namaakun, 'P4' as jenis,
        (select nvl(sum(v_kas_terima),0) as nilai from tmbkuskpdpengeluaran 
        where c_trx = 'P4' and c_angg_tahun = #{tahun} and i_idskpd = #{idskpd}  and i_idbas =  #{idbas} and i_bkuno_ref = #{nobkuref}) as nilai
        from trbas where (i_id = 11558 or i_id = 3908)
        union all
        select i_id as idBas, c_akun as kodeakun, n_akun as namaakun, 'P5' as jenis,
        (select nvl(sum(v_kas_terima),0) as nilai from tmbkuskpdpengeluaran 
        where c_trx = 'P5' and c_angg_tahun = #{tahun} and i_idskpd = #{idskpd}  and i_idbas =  #{idbas} and i_bkuno_ref = #{nobkuref}) as nilai
        from trbas where (i_id = 11559 or i_id = 3909)
        union all
        select i_id as idBas, c_akun as kodeakun, n_akun as namaakun, 'P6' as jenis,
        (select nvl(sum(v_kas_terima),0) as nilai from tmbkuskpdpengeluaran 
        where c_trx = 'P6' and c_angg_tahun = #{tahun} and i_idskpd = #{idskpd}  and i_idbas =  #{idbas} and i_bkuno_ref = #{nobkuref}) as nilai
        from trbas where (i_id = 11557 or i_id = 3907)
        ) a)  WHERE ROWNUM &lt;= #{limit} AND rn &gt; #{offset}
        
    </select>
    
    <select id="getBanyakListPajak" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT count(*) as banyak from (
        select i_id as idBas, c_akun as kodeakun, n_akun as namaakun, 'P1' as jenis from trbas where (i_id = 11554 or i_id = 3904)
        union all
        select i_id as idBas, c_akun as kodeakun, n_akun as namaakun, 'P2' as jenis from trbas where (i_id = 11555 or i_id = 3905)
        union all
        select i_id as idBas, c_akun as kodeakun, n_akun as namaakun, 'P3' as jenis from trbas where (i_id = 11556 or i_id = 3906)
        union all
        select i_id as idBas, c_akun as kodeakun, n_akun as namaakun, 'P4' as jenis from trbas where (i_id = 11558 or i_id = 3908)
        union all
        select i_id as idBas, c_akun as kodeakun, n_akun as namaakun, 'P5' as jenis from trbas where (i_id = 11559 or i_id = 3909)
        union all
        select i_id as idBas, c_akun as kodeakun, n_akun as namaakun, 'P6' as jenis from trbas where (i_id = 11557 or i_id = 3907)
        
        )
    </select> 
    
    <select id="getListIndex" parameterType="spp.model.BukuKasUmum" resultType="spp.model.BukuKasUmum">
        SELECT  idskpd,tglPosting, kodeTransaksi, idTransaksi, noBukti, tglDok, uraianBukti, idKegiatan, kodeKeg, 
        kodeakun, nilaiMasuk,nilaiKeluar,saldoKas, idBas, bkuStatus, ketKegiatan, beban,idBku, jenis, noBKU, noJournal, kodeKoreksi
        FROM  (SELECT   ROWNUM AS rn, a.* FROM ( 
        
        SELECT I_IDSKPD as idskpd , 
        D_POSTING AS tglPosting,
        C_TRX as kodeTransaksi, I_IDTRX as idTransaksi, I_DOC_BUKTI as noBukti, D_DOC_BUKTI as tglDok, E_DOC_BUKTI as uraianBukti, I_IDKEGIATAN as idKegiatan,  kodeKeg, bkuStatus,
        ketKegiatan, I_IDBAS as idBas, C_AKUN as kodeakun, NVL(V_KAS_TERIMA,0) as nilaiMasuk, NVL(V_KAS_KELUAR,0) as nilaiKeluar,
        SUM(NVL(V_KAS_TERIMA,0) - NVL(V_KAS_KELUAR,0)) OVER (PARTITION BY I_IDSKPD ORDER BY ROWNUM, I_IDSKPD RANGE UNBOUNDED PRECEDING) AS saldoKas, 
        C_JENIS as jenis, C_BEBAN as beban, idBku, noBKU, noJournal, kodeKoreksi
        FROM(
        SELECT #{tahun} AS C_ANGG_TAHUN, #{idskpd} AS I_IDSKPD, #{bulan} AS BLN_POSTING, #{tahun}||#{bulan}||'01' AS D_POSTING, 
        null AS C_TRX, null AS I_IDTRX, null AS I_DOC_BUKTI, null AS D_DOC_BUKTI,
        (CASE
        WHEN #{bulan} ='01' THEN 'SALDO AWAL ' || #{tahun}  
        ELSE 'SALDO KAS AWAL ' || UPPER(BULAN(#{bulan})) ||' '|| #{tahun}
        END) AS E_DOC_BUKTI, null AS I_IDKEGIATAN, null AS  ketKegiatan, null  as kodeKeg, null as bkuStatus,
        null AS I_IDBAS, null AS C_AKUN, SUM(V_KAS_TERIMA) AS V_KAS_TERIMA, 0 AS V_KAS_KELUAR
        , NULL C_JENIS, NULL C_BEBAN,  NULL as idBku,   NULL as noBKU, NULL as noJournal, '0' as kodeKoreksi
        FROM (
        SELECT (V_SALDOAWAL_DEBET - V_SALDOAWAL_KREDIT) AS V_KAS_TERIMA
        FROM TMJOURSALDOAWAL A
        WHERE A.C_ANGG_TAHUN = #{tahun}
        AND A.I_IDSKPD = #{idskpd}
        AND I_IDBAS in (39,41,9947,9948,9949,11554,11555,11556,11557,11558,11559,11560)
        UNION ALL
        SELECT SUM(A.V_KAS_TERIMA - A.V_KAS_KELUAR) AS V_KAS_TERIMA
        FROM TMBKUSKPDPENGELUARAN A
        WHERE A.C_ANGG_TAHUN = #{tahun}
        AND A.I_IDSKPD = #{idskpd}
        AND SUBSTR (A.D_POSTING, 5.2) &lt; #{bulan} )
        UNION ALL
        SELECT * FROM(
        SELECT A.C_ANGG_TAHUN, A.I_IDSKPD, SUBSTR (A.D_POSTING, 5,2) AS BLN_POSTING, A.D_POSTING, A.C_TRX, A.I_IDTRX, A.I_DOC_BUKTI, A.D_DOC_BUKTI,
        REPLACE(REPLACE(REPLACE(TRIM(E_DOC_BUKTI),'  ',' '),'  ',' '),'  ',' '),
        A.I_IDKEGIATAN,  DECODE(k.c_kegiatan,NULL,NULL,  k.c_kegiatan || ' / ' || k.n_kegiatan) as ketKegiatan, k.c_kegiatan as kodeKeg,
        A.c_status as bkuStatus, A.I_IDBAS, A.C_AKUN, A.V_KAS_TERIMA, A.V_KAS_KELUAR, A.C_JENIS, A.C_BEBAN , 
        a.i_id as idBku, a.i_bkuno as noBKU,  a.i_jour as noJournal, a.c_bku_koreksi as kodeKoreksi
        FROM TMBKUSKPDPENGELUARAN A  left join tmdpakegiatan k on a.i_idkegiatan = k.i_id
        WHERE A.C_ANGG_TAHUN = #{tahun}
        AND A.I_IDSKPD = #{idskpd}
        AND SUBSTR (A.D_POSTING, 5,2) = #{bulan}
        AND a.c_aktif = 1
        and c_bku_koreksi = 0
        and c_trx = 'JJ'
        
        <if test="idskpd == 761 or idskpd == 1234 ">
            and A.C_WIL_SP2DPROSES = #{kodeWilayah}
        </if>
        
        ORDER BY  a.i_bkuno,  A.D_POSTING, A.I_ID 
        )
        
        UNION ALL
        SELECT * FROM(
        SELECT A.C_ANGG_TAHUN, A.I_IDSKPD, SUBSTR (A.D_POSTING, 5,2) AS BLN_POSTING, A.D_POSTING, A.C_TRX, A.I_IDTRX, A.I_DOC_BUKTI, A.D_DOC_BUKTI,
        REPLACE(REPLACE(REPLACE(TRIM(E_DOC_BUKTI),'  ',' '),'  ',' '),'  ',' '),
        A.I_IDKEGIATAN,  DECODE(k.c_kegiatan,NULL,NULL,  k.c_kegiatan || ' / ' || k.n_kegiatan) as ketKegiatan, k.c_kegiatan as kodeKeg,
        A.c_status as bkuStatus, A.I_IDBAS, A.C_AKUN, A.V_KAS_TERIMA, A.V_KAS_KELUAR, A.C_JENIS, A.C_BEBAN , 
        a.i_id as idBku, a.i_bkuno as noBKU,  a.i_jour as noJournal, a.c_bku_koreksi as kodeKoreksi
        FROM TMBKUSKPDPENGELUARAN A  left join tmdpakegiatan k on a.i_idkegiatan = k.i_id
        WHERE A.C_ANGG_TAHUN = #{tahun}
        AND A.I_IDSKPD = #{idskpd}
        AND SUBSTR (A.D_POSTING, 5,2) = #{bulan}
        AND a.c_aktif = 1
        and c_bku_koreksi = 0
        and c_trx like 'P%'
        and v_kas_terima &gt; 0
        and nvl(i_bkuno_ref,0) != -99
        and i_bkuno_ref is not null 
        
        <if test="idskpd == 761 or idskpd == 1234">
            and A.C_WIL_SP2DPROSES = #{kodeWilayah}
        </if>
        
        ORDER BY  a.i_bkuno,  A.D_POSTING, A.I_ID 
        )
        ) WHERE c_trx = 'JJ' or (c_trx like 'P%' and v_kas_terima &gt; 0)
        
        ) a) 
        WHERE ROWNUM &lt;= #{limit} AND rn &gt; #{offset}
        
    </select>
    
    <select id="getBanyakListIndex" parameterType="spp.model.BukuKasUmum" resultType="java.lang.Integer">
        SELECT count(*) as banyak from (
       SELECT I_IDSKPD as idskpd , 
        D_POSTING AS tglPosting,
        C_TRX as kodeTransaksi, I_IDTRX as idTransaksi, I_DOC_BUKTI as noBukti, D_DOC_BUKTI as tglDok, E_DOC_BUKTI as uraianBukti, I_IDKEGIATAN as idKegiatan,  kodeKeg, bkuStatus,
        ketKegiatan, I_IDBAS as idBas, C_AKUN as kodeakun, NVL(V_KAS_TERIMA,0) as nilaiMasuk, NVL(V_KAS_KELUAR,0) as nilaiKeluar,
        SUM(NVL(V_KAS_TERIMA,0) - NVL(V_KAS_KELUAR,0)) OVER (PARTITION BY I_IDSKPD ORDER BY ROWNUM, I_IDSKPD RANGE UNBOUNDED PRECEDING) AS saldoKas, 
        C_JENIS as jenis, C_BEBAN as beban, idBku, noBKU, noJournal, kodeKoreksi
        FROM(
        SELECT #{tahun} AS C_ANGG_TAHUN, #{idskpd} AS I_IDSKPD, #{bulan} AS BLN_POSTING, #{tahun}||#{bulan}||'01' AS D_POSTING, 
        null AS C_TRX, null AS I_IDTRX, null AS I_DOC_BUKTI, null AS D_DOC_BUKTI,
        (CASE
        WHEN #{bulan} ='01' THEN 'SALDO AWAL ' || #{tahun}  
        ELSE 'SALDO KAS AWAL ' || UPPER(BULAN(#{bulan})) ||' '|| #{tahun}
        END) AS E_DOC_BUKTI, null AS I_IDKEGIATAN, null AS  ketKegiatan, null  as kodeKeg, null as bkuStatus,
        null AS I_IDBAS, null AS C_AKUN, SUM(V_KAS_TERIMA) AS V_KAS_TERIMA, 0 AS V_KAS_KELUAR
        , NULL C_JENIS, NULL C_BEBAN,  NULL as idBku,   NULL as noBKU, NULL as noJournal, '0' as kodeKoreksi
        FROM (
       SELECT SUM(A.V_KAS_TERIMA - A.V_KAS_KELUAR) AS V_KAS_TERIMA
        FROM TMBKUSKPDPENGELUARAN A
        WHERE A.C_ANGG_TAHUN = #{tahun}
        AND A.I_IDSKPD = #{idskpd}
        AND SUBSTR (A.D_POSTING, 5.2) &lt; #{bulan} )
        UNION ALL
        SELECT * FROM(
        SELECT A.C_ANGG_TAHUN, A.I_IDSKPD, SUBSTR (A.D_POSTING, 5,2) AS BLN_POSTING, A.D_POSTING, A.C_TRX, A.I_IDTRX, A.I_DOC_BUKTI, A.D_DOC_BUKTI,
        REPLACE(REPLACE(REPLACE(TRIM(E_DOC_BUKTI),'  ',' '),'  ',' '),'  ',' '),
        A.I_IDKEGIATAN,  DECODE(k.c_kegiatan,NULL,NULL,  k.c_kegiatan || ' / ' || k.n_kegiatan) as ketKegiatan, k.c_kegiatan as kodeKeg,
        A.c_status as bkuStatus, A.I_IDBAS, A.C_AKUN, A.V_KAS_TERIMA, A.V_KAS_KELUAR, A.C_JENIS, A.C_BEBAN , 
        a.i_id as idBku, a.i_bkuno as noBKU,  a.i_jour as noJournal, a.c_bku_koreksi as kodeKoreksi
        FROM TMBKUSKPDPENGELUARAN A  left join tmdpakegiatan k on a.i_idkegiatan = k.i_id
        WHERE A.C_ANGG_TAHUN = #{tahun}
        AND A.I_IDSKPD = #{idskpd}
        AND SUBSTR (A.D_POSTING, 5,2) = #{bulan}
        AND a.c_aktif = 1
        and c_bku_koreksi = 0
        and c_trx = 'JJ'
        <if test="idskpd == 761 or idskpd == 1234">
            and A.C_WIL_SP2DPROSES = #{kodeWilayah}
        </if>
        )
        
        UNION ALL
        SELECT * FROM(
        SELECT A.C_ANGG_TAHUN, A.I_IDSKPD, SUBSTR (A.D_POSTING, 5,2) AS BLN_POSTING, A.D_POSTING, A.C_TRX, A.I_IDTRX, A.I_DOC_BUKTI, A.D_DOC_BUKTI,
        REPLACE(REPLACE(REPLACE(TRIM(E_DOC_BUKTI),'  ',' '),'  ',' '),'  ',' '),
        A.I_IDKEGIATAN,  DECODE(k.c_kegiatan,NULL,NULL,  k.c_kegiatan || ' / ' || k.n_kegiatan) as ketKegiatan, k.c_kegiatan as kodeKeg,
        A.c_status as bkuStatus, A.I_IDBAS, A.C_AKUN, A.V_KAS_TERIMA, A.V_KAS_KELUAR, A.C_JENIS, A.C_BEBAN , 
        a.i_id as idBku, a.i_bkuno as noBKU,  a.i_jour as noJournal, a.c_bku_koreksi as kodeKoreksi
        FROM TMBKUSKPDPENGELUARAN A  left join tmdpakegiatan k on a.i_idkegiatan = k.i_id
        WHERE A.C_ANGG_TAHUN = #{tahun}
        AND A.I_IDSKPD = #{idskpd}
        AND SUBSTR (A.D_POSTING, 5,2) = #{bulan}
        AND a.c_aktif = 1
        and c_bku_koreksi = 0
        and c_trx like 'P%'
        <if test="idskpd == 761 or idskpd == 1234">
            and A.C_WIL_SP2DPROSES = #{kodeWilayah}
        </if>
        and v_kas_terima &gt; 0
        and nvl(i_bkuno_ref,0) != -99
        and i_bkuno_ref is not null 
        )
        )WHERE c_trx = 'JJ' or (c_trx like 'P%' and v_kas_terima &gt; 0))
    </select>    
    
    <select id="getDataPajak" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        select I_BKUNO as noBKU, lower(C_TRX) as kodeTransaksi, I_IDBAS as idBas, V_KAS_TERIMA as nilaiPajak
        from TMBKUSKPDPENGELUARAN
        WHERE C_ANGG_TAHUN = #{tahun}
        AND I_IDSKPD = #{idskpd}
        AND I_DOC_BUKTI = #{nobukti}
        AND D_POSTING = #{tglpost}
        and c_trx like 'P%'
        and i_idkegiatan = #{idkegiatan}
        and i_bkuno_ref = #{nobkuref}
        
    </select>
    
    <delete id="deleteById" parameterType="java.util.Map"  >
        DELETE TMBKUSKPDPENGELUARAN 
        WHERE 
        I_ID = #{idbku}
        AND c_angg_tahun = #{tahun}
    </delete>
    
    <update id="updateById" parameterType="spp.model.BukuKasUmum"   >
        UPDATE TMBKUSKPDPENGELUARAN
        SET
        D_POSTING = #{tglPosting},
        C_TRX = #{kodeTransaksi},
        I_DOC_BUKTI = #{noDok},
        D_DOC_BUKTI = #{tglDok},
        E_DOC_BUKTI = #{uraianBukti},
        I_IDKEGIATAN = #{idKegiatan},
        C_KEGIATAN = #{kodeKeg},
        I_IDBAS = #{idBas},
        C_AKUN = #{kodeakun},
        V_KAS_TERIMA = #{nilaiMasuk},
        V_KAS_KELUAR = #{nilaiKeluar},
        C_JENIS = #{jenis},
        C_BEBAN = #{beban},
        I_FILLING = #{inboxFile},
        I_PPTK_NIP = #{nipPptk},
        N_PPTK = #{namaPptk},
        E_RMKS = #{uraian},
        C_CARA_BAYAR = #{kodePembayaran},
        C_UANGPERSEDIAAN = #{kodeUangPersediaan},
        <if test="kodeTransaksi == 'JJ' ">
            V_SPJ_PAJAK = #{nilaiPajak},
            V_SPJ_NETTO = #{nilaiSpjNetto},
        </if>
        I_PGUN_UBAH = #{idEntry},
        D_PGUN_UBAH = sysdate
        WHERE
        C_ANGG_TAHUN = #{tahun}
        AND I_IDSKPD = #{idskpd}
        AND I_ID = #{idBku}
           
    </update>
    
    <select id="getNilaiSisaSpjTunai" parameterType="java.util.Map" resultType="spp.model.BukuKasUmum">
        select nvl(sum (nilaic1-nilaic2 - nilai_spj),0) as nilaiSisa from (

        select 0 as nilai_spj , sum(v_kas_terima) as nilaic1, 0 as nilaic2 
        from TMBKUSKPDPENGELUARAN 
        where i_idskpd = #{idskpd}
        and c_angg_tahun = #{tahun}
        and c_trx = 'C1' 
        and c_beban in ('UP','GU')
        
       union all
        select 0 as nilai_spj , 0as nilaic1, sum(v_kas_terima)  as nilaic2 
        from TMBKUSKPDPENGELUARAN 
        where i_idskpd = #{idskpd}
        and c_angg_tahun = #{tahun}
        and c_trx = 'C2' 
        and c_beban in ('UP','GU')
       
        union all
        select  sum(v_kas_keluar - v_kas_terima)as nilai_spj , 0 as nilaic1, 0 as nilaic2 
        from  TMBKUSKPDPENGELUARAN 
        where  c_angg_tahun = #{tahun}
        and c_trx ='JJ'
        and i_idskpd = #{idskpd}                           
        and i_bkuno &lt;&gt; #{nobku} 
        and c_beban in ('UP','GU')
        and c_cara_bayar = 1
        
        )            
      
    </select>
    
</mapper>